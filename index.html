<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carris Lisboa - Visualizador Premium</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        #map-container { height: 600px; width: 100%; border-radius: 12px; z-index: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #eab308; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-gray-900">

    <div id="app" class="max-w-6xl mx-auto p-4 sm:p-6">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-400 p-3 rounded-xl shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-black" viewBox="0 0 24 24" fill="currentColor"><path d="M18 11h-1V6c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v5H6c-1.1 0-2 .9-2 2v7c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-7c0-1.1-.9-2-2-2zm-9-5h6v5H9V6zm1 12c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm4 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight italic uppercase">Carris <span class="text-yellow-500">Lisboa</span></h1>
                    <p class="text-sm text-gray-500 font-medium tracking-wide">GTFS Advanced Route Tracker</p>
                </div>
            </div>
            <div id="loader" class="hidden text-sm font-bold text-yellow-600 bg-yellow-50 px-4 py-2 rounded-full border border-yellow-200">
                <div class="loading-spinner"></div> Processando GTFS...
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-2 tracking-[0.2em]">Pesquisar Linha</label>
                    <div class="flex gap-2">
                        <input id="route-input" type="text" placeholder="Ex: 728" 
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-400 outline-none transition-all font-bold text-lg" />
                        <button id="search-btn" class="bg-black text-white px-6 py-3 rounded-xl hover:bg-gray-800 transition-all font-bold italic">OK</button>
                    </div>
                </div>

                <div id="results-panel" class="hidden bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-black mb-4 text-[10px] uppercase text-gray-400 tracking-widest border-b pb-2">Varia√ß√µes Encontradas</h3>
                    <div id="trips-list" class="space-y-3 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-2 rounded-3xl shadow-xl border border-gray-100 overflow-hidden relative">
                    <div id="map-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GTFS_PATH = './gtfs/'; 

        // Configura√ß√£o de Camadas (Street vs Sat√©lite)
        const streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });

        let map = L.map('map-container', {
            center: [38.7369, -9.1427],
            zoom: 13,
            layers: [streetLayer]
        });

        const baseMaps = { "Mapa": streetLayer, "Sat√©lite": satelliteLayer };
        L.control.layers(baseMaps).addTo(map);

        let activeLayers = L.layerGroup().addTo(map);
        let cachedData = { routes: null, trips: null, shapes: null };

        const ui = {
            btn: document.getElementById('search-btn'),
            input: document.getElementById('route-input'),
            loader: document.getElementById('loader'),
            results: document.getElementById('results-panel'),
            tripsList: document.getElementById('trips-list')
        };

        async function fetchGTFS(file) {
            if (cachedData[file.split('.')[0]]) return cachedData[file.split('.')[0]];
            ui.loader.classList.remove('hidden');
            try {
                const response = await fetch(GTFS_PATH + file);
                const text = await response.text();
                const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
                cachedData[file.split('.')[0]] = parsed.data;
                return parsed.data;
            } catch (err) {
                return null;
            } finally {
                ui.loader.classList.add('hidden');
            }
        }

        async function handleSearch() {
            const query = ui.input.value.trim().toUpperCase();
            if (!query) return;

            const routes = await fetchGTFS('routes.txt');
            const route = routes.find(r => r.route_id.toUpperCase() === query || r.route_short_name.toUpperCase() === query);
            
            if (!route) { alert("Linha n√£o encontrada."); return; }

            const trips = await fetchGTFS('trips.txt');
            const routeTrips = trips.filter(t => t.route_id === route.route_id);
            const uniqueShapes = [];
            const seen = new Set();
            routeTrips.forEach(t => { if(!seen.has(t.shape_id)) { seen.add(t.shape_id); uniqueShapes.push(t); }});

            renderTrips(uniqueShapes);
        }

        function renderTrips(trips) {
            ui.results.classList.remove('hidden');
            ui.tripsList.innerHTML = '';
            trips.forEach(trip => {
                const title = trip.trip_headsign || 'Percurso ' + trip.shape_id;
                const div = document.createElement('div');
                div.className = "p-4 bg-gray-50 rounded-xl border border-gray-100";
                div.innerHTML = `
                    <div class="font-bold text-xs mb-3 uppercase">${title}</div>
                    <div class="flex gap-2">
                        <button class="view-btn flex-1 bg-black text-white text-[10px] font-bold py-2 rounded-lg hover:bg-gray-800 tracking-tighter">EXIBIR ROTA</button>
                        <button class="gpx-btn flex-1 bg-green-600 text-white text-[10px] font-bold py-2 rounded-lg hover:bg-green-700 italic">GPX</button>
                    </div>`;
                div.querySelector('.view-btn').onclick = () => drawRoute(trip.shape_id);
                div.querySelector('.gpx-btn').onclick = () => downloadGPX(trip.shape_id, title);
                ui.tripsList.appendChild(div);
            });
        }

        async function drawRoute(shapeId) {
            const shapes = await fetchGTFS('shapes.txt');
            const points = shapes
                .filter(s => s.shape_id === shapeId)
                .sort((a, b) => parseInt(a.shape_pt_sequence) - parseInt(b.shape_pt_sequence))
                .map(p => [parseFloat(p.shape_pt_lat), parseFloat(p.shape_pt_lon)]);

            activeLayers.clearLayers();

            // 1. Linha da Rota
            const polyline = L.polyline(points, { color: '#eab308', weight: 5, opacity: 0.8 }).addTo(activeLayers);

            // 2. Setas de Dire√ß√£o
            L.polylineDecorator(polyline, {
                patterns: [{
                    offset: '5%', repeat: '100px',
                    symbol: L.Symbol.arrowHead({ pixelSize: 12, polygon: false, pathOptions: { stroke: true, color: '#000', weight: 2 }})
                }]
            }).addTo(activeLayers);

            // 3. Marcador de In√≠cio (Ponto Azul)
            L.circleMarker(points[0], { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, fillOpacity: 1 })
                .bindPopup("In√≠cio do Percurso").addTo(activeLayers);

            // 4. Marcador de Fim (Bandeira)
            const flagIcon = L.divIcon({
                html: `<div style="font-size: 20px;">üèÅ</div>`,
                className: 'dummy', iconSize: [20, 20], iconAnchor: [10, 20]
            });
            L.marker(points[points.length - 1], { icon: flagIcon })
                .bindPopup("Fim do Percurso").addTo(activeLayers);

            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }

        async function downloadGPX(shapeId, title) {
            const shapes = await fetchGTFS('shapes.txt');
            const coords = shapes.filter(s => s.shape_id === shapeId).sort((a, b) => parseInt(a.shape_pt_sequence) - parseInt(b.shape_pt_sequence));
            let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="CarrisViewer" xmlns="http://www.topografix.com/GPX/1/1"><trk><name>${title}</name><trkseg>`;
            coords.forEach(p => { gpx += `\n<trkpt lat="${p.shape_pt_lat}" lon="${p.shape_pt_lon}"></trkpt>`; });
            gpx += `\n</trkseg></trk></gpx>`;
            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Carris_${shapeId}.gpx`; a.click();
        }

        ui.btn.onclick = handleSearch;
        ui.input.onkeypress = (e) => { if (e.key === 'Enter') handleSearch(); };
    </script>
</body>
</html>
