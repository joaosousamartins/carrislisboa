<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carris Lisboa - Visualizador & GPX</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        #map-container { height: 600px; width: 100%; border-radius: 12px; z-index: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #eab308; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-gray-900">

    <div id="app" class="max-w-6xl mx-auto p-4 sm:p-6">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-400 p-3 rounded-xl shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-black" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 11h-1V6c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v5H6c-1.1 0-2 .9-2 2v7c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-7c0-1.1-.9-2-2-2zm-9-5h6v5H9V6zm1 12c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm4 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight italic">CARRIS <span class="text-yellow-500 font-black">LISBOA</span></h1>
                    <p class="text-sm text-gray-500 font-medium">GTFS Visualizador & Exportador GPX</p>
                </div>
            </div>
            <div id="loader" class="hidden text-sm font-bold text-yellow-600 bg-yellow-50 px-4 py-2 rounded-full border border-yellow-200">
                <div class="loading-spinner"></div> A carregar dados...
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-2 tracking-widest">Linha</label>
                    <div class="flex gap-2">
                        <input id="route-input" type="text" placeholder="Ex: 728" 
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-400 outline-none transition-all font-bold text-lg" />
                        <button id="search-btn" class="bg-black text-white px-6 py-3 rounded-xl hover:bg-gray-800 transition-all font-bold">OK</button>
                    </div>
                </div>

                <div id="results-panel" class="hidden bg-white p-4 rounded-2xl shadow-sm border border-gray-100 font-sans">
                    <h3 class="font-black mb-4 text-xs uppercase text-gray-400 tracking-widest border-b pb-2">Resultados</h3>
                    <div id="trips-list" class="space-y-3 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-2 rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                    <div id="map-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GTFS_PATH = './gtfs/'; 
        
        let map = L.map('map-container').setView([38.7369, -9.1427], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let currentLayer = null;
        let cachedData = { routes: null, trips: null, shapes: null };

        const ui = {
            btn: document.getElementById('search-btn'),
            input: document.getElementById('route-input'),
            loader: document.getElementById('loader'),
            results: document.getElementById('results-panel'),
            tripsList: document.getElementById('trips-list')
        };

        async function fetchGTFS(file) {
            if (cachedData[file.split('.')[0]]) return cachedData[file.split('.')[0]];
            ui.loader.classList.remove('hidden');
            try {
                const response = await fetch(GTFS_PATH + file);
                if (!response.ok) throw new Error();
                const text = await response.text();
                const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
                cachedData[file.split('.')[0]] = parsed.data;
                return parsed.data;
            } catch (err) {
                alert(`Erro ao ler ${file}. Verifique se a pasta /gtfs/ está correta.`);
                return null;
            } finally {
                ui.loader.classList.add('hidden');
            }
        }

        async function handleSearch() {
            const query = ui.input.value.trim().toUpperCase();
            if (!query) return;

            const routes = await fetchGTFS('routes.txt');
            if (!routes) return;

            const route = routes.find(r => r.route_id.toUpperCase() === query || r.route_short_name.toUpperCase() === query);
            if (!route) { alert("Linha não encontrada."); return; }

            const trips = await fetchGTFS('trips.txt');
            const routeTrips = trips.filter(t => t.route_id === route.route_id);

            const uniqueShapes = [];
            const seenShapes = new Set();
            routeTrips.forEach(t => {
                if (!seenShapes.has(t.shape_id)) {
                    seenShapes.add(t.shape_id);
                    uniqueShapes.push(t);
                }
            });

            renderTrips(uniqueShapes);
        }

        function renderTrips(trips) {
            ui.results.classList.remove('hidden');
            ui.tripsList.innerHTML = '';

            trips.forEach(trip => {
                const container = document.createElement('div');
                container.className = "p-4 bg-gray-50 rounded-xl border border-gray-100 space-y-3";
                
                const title = trip.trip_headsign || 'Percurso ' + trip.shape_id;
                
                container.innerHTML = `
                    <div>
                        <div class="font-black text-sm uppercase text-gray-700">${title}</div>
                        <div class="text-[10px] text-gray-400">Shape ID: ${trip.shape_id}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="view-btn flex-1 bg-yellow-400 text-black text-xs font-bold py-2 rounded-lg hover:bg-yellow-500 transition-all">
                            VER MAPA
                        </button>
                        <button class="gpx-btn flex-1 bg-green-600 text-white text-xs font-bold py-2 rounded-lg hover:bg-green-700 transition-all flex items-center justify-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            GPX
                        </button>
                    </div>
                `;

                container.querySelector('.view-btn').onclick = () => drawRoute(trip.shape_id);
                container.querySelector('.gpx-btn').onclick = () => downloadGPX(trip.shape_id, title);
                
                ui.tripsList.appendChild(container);
            });
        }

        async function getCoordinates(shapeId) {
            const shapes = await fetchGTFS('shapes.txt');
            if (!shapes) return null;
            return shapes
                .filter(s => s.shape_id === shapeId)
                .sort((a, b) => parseInt(a.shape_pt_sequence) - parseInt(b.shape_pt_sequence))
                .map(p => ({
                    lat: parseFloat(p.shape_pt_lat),
                    lon: parseFloat(p.shape_pt_lon)
                }));
        }

        async function drawRoute(shapeId) {
            const coords = await getCoordinates(shapeId);
            if (!coords) return;
            const points = coords.map(c => [c.lat, c.lon]);

            if (currentLayer) map.removeLayer(currentLayer);
            currentLayer = L.polyline(points, { color: '#000', weight: 6, opacity: 0.2 }).addTo(map);
            const activeLine = L.polyline(points, { color: '#eab308', weight: 4 }).addTo(map);
            currentLayer = L.layerGroup([currentLayer, activeLine]).addTo(map);

            map.fitBounds(points, { padding: [40, 40] });
        }

        async function downloadGPX(shapeId, title) {
            const coords = await getCoordinates(shapeId);
            if (!coords) return;

            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="CarrisLisboaViewer" xmlns="http://www.topografix.com/GPX/1/1">
  <trk>
    <name>Carris - ${title}</name>
    <trkseg>`;
            
            coords.forEach(p => {
                gpx += `\n      <trkpt lat="${p.lat}" lon="${p.lon}"></trkpt>`;
            });

            gpx += `\n    </trkseg>\n  </trk>\n</gpx>`;

            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Carris_${shapeId}.gpx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        ui.btn.onclick = handleSearch;
        ui.input.onkeypress = (e) => { if (e.key === 'Enter') handleSearch(); };
    </script>
</body>
</html>
