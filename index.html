<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carris Lisboa - Explorer Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        #map-container { height: 600px; width: 100%; border-radius: 12px; z-index: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #fbbf24; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="app" class="max-w-6xl mx-auto p-4 sm:p-6">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-400 p-3 rounded-2xl shadow-lg border-b-4 border-yellow-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-black" viewBox="0 0 24 24" fill="currentColor"><path d="M18 11h-1V6c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v5H6c-1.1 0-2 .9-2 2v7c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-7c0-1.1-.9-2-2-2zm-9-5h6v5H9V6zm1 12c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm4 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tighter italic uppercase leading-none">Carris <span class="text-yellow-500">Lisboa</span></h1>
                    <p class="text-xs text-slate-400 font-bold tracking-[0.3em] uppercase mt-1">GTFS Live Mapping</p>
                </div>
            </div>
            <div id="loader" class="hidden text-xs font-black text-yellow-700 bg-yellow-100 px-4 py-2 rounded-full border border-yellow-200 animate-pulse">
                <div class="loading-spinner"></div> A LER GTFS...
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">N√∫mero da Linha</label>
                    <div class="flex gap-2">
                        <input id="route-input" type="text" placeholder="Ex: 728" 
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-yellow-400 outline-none transition-all font-bold text-xl" />
                        <button id="search-btn" class="bg-slate-900 text-white px-6 py-3 rounded-2xl hover:bg-black transition-all font-black">OK</button>
                    </div>
                </div>

                <div id="results-panel" class="hidden bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                    <div class="mb-4">
                        <h2 id="route-display-name" class="text-lg font-black leading-tight text-slate-800"></h2>
                        <span id="route-display-id" class="text-[10px] font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded uppercase tracking-wider"></span>
                    </div>
                    <h3 class="font-black mb-3 text-[10px] uppercase text-slate-300 tracking-[0.2em] border-b pb-2">Destinos Dispon√≠veis</h3>
                    <div id="trips-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-2 rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden relative">
                    <div id="map-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GTFS_PATH = './gtfs/'; 

        const streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });

        let map = L.map('map-container', { center: [38.7369, -9.1427], zoom: 13, layers: [streetLayer] });
        L.control.layers({ "Mapa": streetLayer, "Sat√©lite": satelliteLayer }, null, { position: 'bottomright' }).addTo(map);

        let activeLayers = L.layerGroup().addTo(map);
        let cachedData = { routes: null, trips: null, shapes: null };

        const ui = {
            btn: document.getElementById('search-btn'),
            input: document.getElementById('route-input'),
            loader: document.getElementById('loader'),
            results: document.getElementById('results-panel'),
            tripsList: document.getElementById('trips-list'),
            routeName: document.getElementById('route-display-name'),
            routeId: document.getElementById('route-display-id')
        };

        async function fetchGTFS(file) {
            if (cachedData[file.split('.')[0]]) return cachedData[file.split('.')[0]];
            ui.loader.classList.remove('hidden');
            try {
                const response = await fetch(GTFS_PATH + file);
                const text = await response.text();
                const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
                cachedData[file.split('.')[0]] = parsed.data;
                return parsed.data;
            } catch (err) { return null; } finally { ui.loader.classList.add('hidden'); }
        }

        async function handleSearch() {
            const query = ui.input.value.trim().toUpperCase();
            if (!query) return;

            const routes = await fetchGTFS('routes.txt');
            const route = routes.find(r => r.route_id.toUpperCase() === query || r.route_short_name.toUpperCase() === query);
            
            if (!route) { alert("Linha n√£o encontrada."); return; }

            ui.routeName.innerText = route.route_long_name;
            ui.routeId.innerText = `Linha ${route.route_short_name}`;

            const trips = await fetchGTFS('trips.txt');
            const routeTrips = trips.filter(t => t.route_id === route.route_id);
            const uniqueShapes = [];
            const seen = new Set();
            routeTrips.forEach(t => { if(!seen.has(t.shape_id)) { seen.add(t.shape_id); uniqueShapes.push(t); }});

            renderTrips(uniqueShapes, route.route_long_name);
        }

        function renderTrips(trips, longName) {
            ui.results.classList.remove('hidden');
            ui.tripsList.innerHTML = '';
            trips.forEach(trip => {
                // Aqui usamos o route_long_name se o trip_headsign for vazio
                const title = trip.trip_headsign || longName;
                const div = document.createElement('div');
                div.className = "p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-yellow-400 transition-all group";
                div.innerHTML = `
                    <div class="font-black text-[11px] mb-3 uppercase text-slate-600 group-hover:text-slate-900 leading-tight">${title}</div>
                    <div class="flex gap-2">
                        <button class="view-btn flex-[2] bg-slate-900 text-white text-[10px] font-black py-2.5 rounded-xl hover:bg-yellow-500 hover:text-black transition-all uppercase italic">Mapear</button>
                        <button class="gpx-btn flex-1 bg-white text-slate-400 border border-slate-200 text-[10px] font-black py-2.5 rounded-xl hover:text-green-600 hover:border-green-600 transition-all uppercase">GPX</button>
                    </div>`;
                div.querySelector('.view-btn').onclick = () => drawRoute(trip.shape_id);
                div.querySelector('.gpx-btn').onclick = () => downloadGPX(trip.shape_id, title);
                ui.tripsList.appendChild(div);
            });
        }

        async function drawRoute(shapeId) {
            const shapes = await fetchGTFS('shapes.txt');
            const points = shapes
                .filter(s => s.shape_id === shapeId)
                .sort((a, b) => parseInt(a.shape_pt_sequence) - parseInt(b.shape_pt_sequence))
                .map(p => [parseFloat(p.shape_pt_lat), parseFloat(p.shape_pt_lon)]);

            activeLayers.clearLayers();

            const polyline = L.polyline(points, { color: '#fbbf24', weight: 6, opacity: 0.9, lineCap: 'round' }).addTo(activeLayers);

            L.polylineDecorator(polyline, {
                patterns: [{
                    offset: '10%', repeat: '80px',
                    symbol: L.Symbol.arrowHead({ pixelSize: 10, polygon: false, pathOptions: { stroke: true, color: '#000', weight: 3, opacity: 1 }})
                }]
            }).addTo(activeLayers);

            L.circleMarker(points[0], { radius: 7, fillColor: "#3b82f6", color: "#fff", weight: 3, fillOpacity: 1 }).addTo(activeLayers);
            
            const lastPoint = points[points.length - 1];
            L.marker(lastPoint, { 
                icon: L.divIcon({ html: '<div class="text-xl">üèÅ</div>', className: 'dummy', iconSize: [24, 24], iconAnchor: [12, 24] }) 
            }).addTo(activeLayers);

            map.fitBounds(polyline.getBounds(), { padding: [60, 60] });
        }

        async function downloadGPX(shapeId, title) {
            const shapes = await fetchGTFS('shapes.txt');
            const coords = shapes.filter(s => s.shape_id === shapeId).sort((a, b) => parseInt(a.shape_pt_sequence) - parseInt(b.shape_pt_sequence));
            let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="CarrisViewer" xmlns="http://www.topografix.com/GPX/1/1"><trk><name>${title}</name><trkseg>`;
            coords.forEach(p => { gpx += `\n<trkpt lat="${p.shape_pt_lat}" lon="${p.shape_pt_lon}"></trkpt>`; });
            gpx += `\n</trkseg></trk></gpx>`;
            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Carris_${shapeId}.gpx`; a.click();
        }

        ui.btn.onclick = handleSearch;
        ui.input.onkeypress = (e) => { if (e.key === 'Enter') handleSearch(); };
    </script>
</body>
</html>
